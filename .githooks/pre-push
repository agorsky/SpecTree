#!/bin/bash
# Git Release Flow - Pre-push safety check
# Prevents force push to protected branches

PROTECTED_BRANCHES="^(main|release/.*)$"

while read local_ref local_sha remote_ref remote_sha; do
  # Extract branch name from ref
  branch=$(echo "$remote_ref" | sed 's|refs/heads/||')
  
  if [[ "$branch" =~ $PROTECTED_BRANCHES ]]; then
    # Check if this is a force push (non-fast-forward)
    if [ "$remote_sha" != "0000000000000000000000000000000000000000" ]; then
      # Check if local_sha is a descendant of remote_sha
      if ! git merge-base --is-ancestor "$remote_sha" "$local_sha" 2>/dev/null; then
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸš« BLOCKED: Force push to protected branch '$branch'"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "Force pushing to 'main' or 'release/*' branches is forbidden."
        echo "This protects QA-validated commits and shared work."
        echo ""
        echo "If you need to update your feature branch:"
        echo "  git push --force-with-lease origin <your-feature-branch>"
        echo ""
        echo "Policy: docs/GIT/git-release-flow-strategy-final-with-definitions.md"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        exit 1
      fi
    fi
  fi
done

exit 0
